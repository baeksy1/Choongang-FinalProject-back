<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.server.cloud.alarm.service.AlarmMapper">
  
  	<insert id="createProAlarm">
  		INSERT INTO ALARM (ALARM_CONTENT,ALARM_TYPE,ALARM_RECEIVER) 
  		VALUES('새로운 프로젝트가 등록 됐습니다 팀 배정 해주세요 ('||#{project_name}||')','AD_PRO','admin')
  	</insert>
  	
  	<insert id="assignEngineer">
  		INSERT INTO ALARM (ALARM_CONTENT,ALARM_TYPE,ALARM_RECEIVER) 
  		VALUES('새로운 서버를 배정 받았습니다. 정기점검 날짜를 확인해주세요.','ENG_ASS',#{eng_id})
  	</insert>
  	
  	<insert id="assignTeam">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		SELECT '새로운 프로젝트가 배정 됐습니다. 팀원을 배정해주세요.', 'ENGL_ASS', E.ENG_ENID
		FROM ENGINEER E
		LEFT JOIN ENG_TEAM T ON E.TEAM_NUM = T.TEAM_NUM
		WHERE T.TEAM_ID = #{eng_team} AND E.ENG_RANK = '팀장'
  	</insert>
  	
  	<insert id="assignClient">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('요청하신 프로젝트가 승인 됐습니다. 엔지니어 배정 완료','CUS_ASS',#{user_id}) 
  	</insert>
  	
  	<select id="todayAlarmCheck">
  		SELECT COUNT(*) AS ROW_COUNT
		FROM SERVER S
		LEFT JOIN ENGINEER E ON S.ENG_ENID = E.ENG_ENID
		LEFT JOIN PROJECTINFO P ON S.PRO_ID = P.PRO_ID
		WHERE S.ENG_ENID = #{eng_id}
		AND DATE_FORMAT(NOW(), '%d') = P.PRO_PI; 
  	</select>
  	
  	<insert id="todayAlarmEng">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('오늘은 정기점검이 있는 날입니다. 빠른 점검 부탁드립니다.','ENG_TODAY',#{eng_id})
  	</insert>
  	
  	<select id="todayAlarmCheck2">
  		SELECT COUNT(*) AS ROW_COUNT 
  		FROM PROJECTINFO 
  		WHERE PRO_PI = DATE_FORMAT(NOW(), '%d') 
  		AND CUS_ID = #{cus_id};
  	</select>
  	
  	<insert id="todayAlarmCus">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('오늘은 정기점검이 있는 날입니다!','CUS_TODAY',#{cus_id})
  	</insert>
  	
  	<insert id="emergencyRequest">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('긴급 점검이 들어왔습니다. 신속하게 담당 기사 배정해주세요.('||#{serverName}||')','ENGL_EMR',(SELECT ENG_ENID FROM ENGINEER E LEFT JOIN PROJECTINFO P ON E.TEAM_NUM = P.TEAM_NUM WHERE P.PRO_ID = #{proId} AND E.ENG_RANK = '팀장')
  	</insert>
  	
  	<insert id="assignEmerEng">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('긴급 요청건이 배정되었습니다. 신속한 확인 부탁드립니다.','ENG_EMR',#{eng_id})
  	</insert>
  	
  	<insert id="assignEmerCus">
  		INSERT INTO ALARM (ALARM_CONTENT, ALARM_TYPE, ALARM_RECEIVER)
		VALUES ('긴급 요청건의 담당 기사가 배정되었습니다.','CUS_EMR',SELECT P.CUS_ID FROM SERVER S LEFT JOIN PROJECTINFO P ON S.PRO_ID = P.PRO_ID WHERE SERVER_ID = #{server_id})
  	</insert>
  	
  	<select id="getAlarmList">
  		SELECT * FROM ALARM WEHRE ALARM_RECEIVER = #{user_id}
  	</select>
 

  
  
  </mapper>